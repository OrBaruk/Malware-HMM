#!/bin/bash

# Binaries
mfa2long=./bin/mfa2long
encoder=./bin/encoder

# Folders
clusters=./data/clusters
alignment=./data/train/alignment
sequences=./data/train/sequences
long=./data/train/alignment/long
hmm=./hmm
database=./database

# create dirs


# build stuff used here

# Clean
rm $sequences/*
rm $alignment/*
rm $long/*
rm $hmm/*
rm $database/*

for d in $clusters/*/
do
	for c in $d*/
	do
		filename=$(basename $c)
		echo $filename

		# Encode files
		$encoder $c*.beh > $sequences/$filename.fa

		# MSA
		#mafft --auto --text $sequences/$filename.fa > $alignment/$filename.mfa 2> /dev/null
		muscle -in $sequences/$filename.fa -out $alignment/$filename.mfa  -matrix ./data/pair_matrix.txt -gapopen -18.0 -gapextend -1.0 -center 0.0

		lines=$(wc -l < $alignment/$filename.mfa)

		# Checks if we have enough samples for a hmm
		if [ $lines -gt 2 ]
		then
			# Convert to long
			$mfa2long $alignment/$filename.mfa > $long/$filename.long

			hmmbuild $hmm/$filename.hmm $alignment/$filename.mfa
		fi

	done
done

$encoder ./data/AntiVir_test/* > ./data/test/All.fa

cat $hmm/*.hmm > $database/db.mhmm
hmmpress $database/db.mhmm
