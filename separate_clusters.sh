#!/bin/bash

# filelist
files=("ADSPY" "BDS-Backdoor" "BDS-Bifrose" "BDS-Hupigon" "BDS-Udr" "DIAL" "DR-Delphi"
"GAME-Casino" "GAME-Dldr-Fenomen" "GAME-Dldr-TryMedia" "TR-Agent" #"TR-Crypt-CFI" "HEUR"
# "TR-Crypt-TPM" "TR-Crypt-ULPM" "TR-Crypt-XDR" "TR-Crypt-XPACK" "TR-Crypt-ZPACK"
"TR-Dldr-Delphi" "TR-Dldr-Swizzor" "TR-Downloader" "TR-Drop-" "TR-Dropper-Gen"
"TR-Luder-Patched" "TR-Spy" "W32-Parite" "W32-Virut" "WORM-Allaple" "Worm-VB")

# files=("Trojan.Agent" "Trojan.Pincav" "Worm.Allaple" "Worm.Palevo"
# "dedler" "heolag" "tibbs")

# Small sample size // Ignored
#"Trojan.Bifrose" "Trojan.Buzus" "Trojan.Downloader" "Trojan.Dropper"
#"Trojan.FakeSSH" "Trojan.IRCBot" "Trojan.Lolbot" "Trojan.Renos" "Trojan.Inject"
#"Trojan.SdBot" "Trojan.Small" "Trojan.Spy" "Trojan.TDSS" "Trojan.Zbot"
#"W32.Virut" "Worm.Agent" "Worm.Autorun" "Worm.Bybz" "Worm.Kolab" "Worm.Peda"
#"Trojan.Nepoe" "UNKNOWN"

if [ $# -ne 2 ]
then
	echo "Usage: ./separate_clusters.sh ./data/logs ./data/clusters"
	exit 1
fi

#folders
logs=$1
clusters=$2

#binaries
histogram=./bin/hist
getcluster=./scripts/getcluster.py
meanshift=./scripts/meanshift.py

# clean
rm $clusters/*

# cluster files
for file in "${files[@]}"
do
	echo ">>$file"
	mkdir -p $clusters/$file
	cp $logs/$file* $clusters/$file/
done
echo ""

for d in $clusters/*/
do
	echo $d
	$histogram $d* > "$d"histogram.txt
	python3 $meanshift "$d"histogram.txt > "$d"clusters.txt
	for f in $d/*.beh
	do
		lines=$(wc -l < $f | sed "s/ //g")
		clust=$(python3 $getcluster "$d"clusters.txt $lines)
		mkdir -p $d"$(basename $d)"_$clust
		mv $f $d"$(basename $d)"_$clust/$(basename $f)
	done

done
echo""
